sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","leco/productionorderconfirmation/util/formatter","sap/ui/model/json/JSONModel"],function(e,t,s,r){"use strict";return e.extend("leco.productionorderconfirmation.controller.ProductionOrderConfirmation",{formatter:s,onInit(){const e=new Date;const t=e.toISOString().split("T")[0];this.byId("confdateInput").setValue(t);const s=this.byId("ordernoInput");if(s){s.addEventDelegate({onkeypress:function(e){var t=/^[0-9]$/;if(!t.test(e.key)){e.preventDefault()}}})}this.byId("_IDGenHBox6").setVisible(false)},onOrderNoChange:function(e){var t=e.getParameter("value");if(t.length>12){e.getSource().setValue(t.substring(0,12))}},onScanSuccess:function(e){if(e.getParameter("cancelled")){MessageToast.show("Scan cancelled",{duration:1e3})}else{if(e.getParameter("text")!==undefined&&e.getParameter("text")!==null){const t=e.getParameter("text");const s=e.getSource();const r=s.getCustomData().find(e=>e.getKey()==="targetInputId")?.getValue();if(r){const e=this.byId(r);if(e){e.setValue(t)}switch(r){case"ordernoInput":this.onGetDetails();break;case"serialnoInput":this.onAddSerial();break;case"serialfromInput":const e=this.byId("serialtoInput").getValue();if(!r||!e){break}else{this.onAddSerial();break}case"serialtoInput":const t=this.byId("serialfromInput").getValue();if(!r||!t){break}else{this.onAddSerial();break}default:break}}}else{this.byId("ordernoInput").setValue("")}}},onScanError:function(e){MessageToast.show("Scan failed: "+e,{duration:1e3})},onGetDetails:function(){const e=this.getView();const s=e.getModel();const n=this.byId("ordernoInput").getValue();this.byId("ordernoInput").setValue("");const o=this.byId("plantInput").getValue();const i=this.getView().getModel("i18n").getResourceBundle();const a="/ET_HEADERSet(OrderNumber='"+n+"',ProductionPlant='"+o+"')";s.read(a,{success:function(e){console.log("Data retrieved:",e);this.byId("materialInput").setValue(e.Material);this.byId("orderqtyInput").setValue(e.TargetQuantity);this.byId("ordertypeInput").setValue(e.OrderType);this.byId("strlocationInput").setValue(e.StrLoc);this.byId("uomInput").setValue(e.Unit);if(e.OpenQty.includes(".")){e.OpenQty=e.OpenQty.split(".")[0];this.byId("openqtyInput").setValue(e.OpenQty)}this.byId("sonoInput").setValue(e.SalesOrder);this.byId("soitemInput").setValue(e.SalesOrderItem);this.byId("confqtyInput").setEditable(false).setValue(0);this.byId("sotextInput").setValue(e.SoText);this.byId("plantInput").setValue(e.ProductionPlant);this.byId("ordernoReadonlyInput").setValue(e.OrderNumber);const t=this.getView();t.byId("workorderdataPanel").setVisible(true);t.byId("serialnumberentryPanel").setVisible(true);t.byId("serialnumberdataPanel").setVisible(true);t.byId("saveButton").setVisible(true);t.byId("finalCheckbox").setVisible(true);const s=t.getModel("serialModel");if(!s){const e=new r({records:[]});this.getView().setModel(e,"serialModel")}if(!e.SerialManaged){this.scenarioNoSerials()}}.bind(this),error:function(e){console.error("Error fetching data:",e);try{const t=JSON.parse(e.responseText);if(t&&t.error&&t.error.message&&t.error.message.value){var s=t.error.message.value}}catch(t){s=e.message||e.responseText}t.error(s)}})},onSingleSelect:function(){this.byId("_IDGenHBox6").setVisible(false);this.byId("_IDGenHBox5").setVisible(true);this.byId("addButton").setVisible(true);if(this.byId("confqtyInput").getEditable()){this.byId("confqtyInput").setEditable(false).setValue(0)}this.byId("serialnumberdataPanel").setVisible(true)},onRangeSelect:function(){this.byId("_IDGenHBox5").setVisible(false);this.byId("_IDGenHBox6").setVisible(true);this.byId("addButton").setVisible(true);this.byId("confqtyInput").setEditable(false);this.byId("serialnumberdataPanel").setVisible(true);if(this.byId("confqtyInput").getEditable()){this.byId("confqtyInput").setEditable(false).setValue(0)}},scenarioNoSerials:function(){this.byId("serialnumberentryPanel").setVisible(false);this.byId("serialnumberdataPanel").setVisible(false);this.byId("confqtyInput").setEditable(true).setValue(0);const e=this.getView().getModel("serialModel");if(e){const e=new r({records:[]});this.getView().setModel(e,"serialModel")}},onClear:function(){const e=this.getView();const t=e.getModel("serialModel");const s=new Date;const r=s.toISOString().split("T")[0];if(t){t.setProperty("/records",[])}e.byId("workorderdataPanel").setVisible(false);e.byId("serialnumberentryPanel").setVisible(false);e.byId("serialnumberdataPanel").setVisible(false);e.byId("saveButton").setVisible(false);e.byId("finalCheckbox").setVisible(false);this.byId("materialInput").setValue("");this.byId("orderqtyInput").setValue("");this.byId("ordertypeInput").setValue("");this.byId("strlocationInput").setValue("");this.byId("uomInput").setValue("");this.byId("openqtyInput").setValue("");this.byId("sonoInput").setValue("");this.byId("soitemInput").setValue("");this.byId("confqtyInput").setValue("");this.byId("serialnoInput").setValue("");this.byId("confdateInput").setValue(r);this.byId("sotextInput").setValue("");this.byId("ordernoInput").setValue("");this.byId("plantInput").setValue("");this.byId("ordernoReadonlyInput").setValue("");this.byId("finalCheckbox").setSelected(false);this.byId("confqtyInput").setEditable(false).setValue(0)},onAddSerial:function(){const e=this.getView();const t=e.getModel("serialModel");if(!t){const e=new r({records:[]});this.getView().setModel(e,"serialModel")}const s=this.byId("ordernoReadonlyInput").getValue();const n=e.byId("serialnoInput");const o=n.getValue().trim();n.setValue("");const i=e.byId("serialfromInput");const a=i.getValue().trim();i.setValue("");const l=e.byId("serialtoInput");const d=l.getValue().trim();l.setValue("");this.getSerialNumber(s,o,a,d)},_buildRange:function(e,s){const r=e.match(/\D+|\d+/g);const n=s.match(/\D+|\d+/g);if(!r||!n||r.length!==n.length){t.error("Start and end formats do not match.");console.error("Start and end formats do not match.");return[]}let o=-1;for(let e=0;e<r.length;e++){if(!isNaN(r[e])&&r[e]!==n[e]){o=e;break}}if(o===-1){t.error("No numeric range found.");console.error("No numeric range found.");return[]}const i=parseInt(r[o],10);const a=parseInt(n[o],10);const l=r[o].length;let d=[];for(let e=i;e<=a;e++){const t=e.toString().padStart(l,"0");const s=[...r];s[o]=t;d.push(s.join(""))}return d},getSerialNumber:function(e,s,n,o){const i=this.getView();const a=i.getModel();const l=i.getModel("serialModel");if(!l){const e=new r({records:[]});this.getView().setModel(e,"serialModel")}if(!s){var d=this._buildRange(n,o)}else{var d=[s]}d.forEach(function(s){const r="/ET_SERIALNUMBERSet(ProductionOrder='"+e+"',SerialNumber='"+s+"')";a.read(r,{success:function(e){console.log("Data retrieved:",e);let t=l.getProperty("/records");t.push({nosave:e.NoSave,notfound:e.NotFound,productionorder:e.ProductionOrder,serialnumber:e.SerialNumber,serialstatus:e.SerialStatus});const s=new Set;t=t.filter(e=>{if(s.has(e.serialnumber)){return false}s.add(e.serialnumber);return true});const r=t.length;i.byId("confqtyInput").setValue(r);const n=i.byId("openqtyInput").getValue();const o=r>=n?true:false;i.byId("finalCheckbox").setSelected(o);t.sort((e,t)=>e.serialnumber.localeCompare(t.serialnumber,undefined,{numeric:true,sensitivity:"base"}));l.setProperty("/records",t);l.refresh(true)}.bind(this),error:function(e){console.error("Error fetching data:",e);try{const t=JSON.parse(e.responseText);if(t&&t.error&&t.error.message&&t.error.message.value){var s=t.error.message.value}}catch(t){s=e.message||e.responseText}t.error(s)}})})},onDelete:function(e){const t=e.getSource();const s=t.getBindingContext("serialModel");const r=s.getPath();const n=parseInt(r.split("/")[2]);const o=this.getView().getModel("serialModel");const i=o.getProperty("/records");i.splice(n,1);o.setProperty("/records",i);const a=i.length;const l=this.getView();l.byId("confqtyInput").setValue(a);const d=this.byId("openqtyInput").getValue();const u=a>=d?true:false;l.byId("finalCheckbox").setSelected(u);o.refresh(true)},onSave:function(){const e=this.getView().getModel("serialModel");const s=e.getData();const r=this.byId("strlocationInput").getValue();const n=this.byId("confdateInput").getValue();const o=this.byId("finalCheckbox").getSelected();const i=this.byId("confqtyInput").getValue();const a={ProductionOrder:"",StrLoc:"",ConfDate:"",ConfQty:"",ToSerials:[],TestFlag:false,FinalFlag:o};const l=true;const d="";a.ProductionOrder=this.byId("ordernoReadonlyInput").getValue();a.StrLoc=r;a.ConfDate=n;a.ConfQty=i;if(i==="0"&&s.records.length===0){t.error("Confirmation Qty is required");return}for(let e=0;e<s.records.length;e++){if(s.records[e].nosave){l=false;d=s.records[e].serialnumber;break}a.ToSerials.push({SerialNumber:s.records[e].serialnumber})}if(!l){t.error("Serial "+d+" is not valid, delete it before continuing");return}const u=this.getView().getModel();u.setUseBatch(false);u.create("/ET_SERIALSWRAPPERSet",a,{success:function(e,s){if(e.MessageType==="E"||e.MessageType==="A"){t.error("Error: "+e.Message)}else{console.log("Doc Created: "+e.MatDoc);if(e.Message){console.log(e.Message)}this.onClear()}}.bind(this),error:function(e){t.error("Odata service call failed");console.log("Odata service call failed")}})}})});
//# sourceMappingURL=ProductionOrderConfirmation.controller.js.map